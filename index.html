<!doctype>
<html>

<head>
    <title>abi2html</title>
    <link rel="stylesheet" href="index.css">
    <script type="text/javascript" src="./dist/bignumber.min.js"></script>
    <script type="text/javascript" src="./dist/web3-light.js"></script>
    <script type="text/javascript" src="./abiHtml.js"></script>
    <script type="text/javascript" src="./abiReader.js"></script>
    <script type="text/javascript">
    // initalize web3
    var web3 = require('web3');
    var contracts;
    // set global events
    window.onload = function() {
        // set event handlers
        document.getElementById('send_value').addEventListener('click', sendValue, false);

        // document.getElementById('toggle-mine').addEventListener('click', function() {
        //     toggleMining()
        // }, false);

        document.getElementById('gasprice-copy').addEventListener('click', function() {
            getNetworkGasPrice(renderUserGasPrice)
                // renderGasPriceEstimate()

        }, false);

        document.getElementById('copy-from').addEventListener('click', function() {
            document.getElementById('contract_address').value = getSenderAddress()
            updateBalances()
        }, false);

        document.getElementById('copy-receipt').addEventListener('click', function() {
            var v = web3.eth.getTransactionReceipt(getTransactionHash())
            if (v) {
                document.getElementById('contract_address').value = v.contractAddress
                updateBalances()
                watchAllEvents()
            }
        }, false);

        document.getElementById('sender_address').addEventListener('change', function() {
            renderAccountBalance('sender_balance', getBalance(getSenderAddress()))
        }, false);

        document.getElementById('gas_price_unit').addEventListener('change', function() {
            var gasprice = document.getElementById('gas_price').value
            var gaspriceunit = document.getElementById('gas_price_unit').value
            getNetworkGasPrice(renderUserGasPrice) // this overrides the number part
        }, false);

        document.getElementById('compile-contract').addEventListener('click', function() {
            compileSolidity(document.getElementById('contract-code').value, function(err, result) {
                if (err)
                    alert(err)
                else {
                    contracts = result
                    setContractSelector('contract-selector', result)
                    renderContractInfo('contract-abi', getSelectedContract('contract-selector'))
                    generateDoc();
                    document.getElementById('deploy-contract').disabled = false
                    if (getContractAddress())
                        watchAllEvents()
                }
            })

        }, false);

        document.getElementById('contract-selector').addEventListener('change', function() {
            renderContractInfo('contract-abi', getSelectedContract('contract-selector'))
            unset()
            generateDoc();
            watchAllEvents();
        })

        document.getElementById('deploy-contract').addEventListener('click', function() {
            contract = getSelectedContract('contract-selector')
            deployContract(contract.code, function(error, result) {
                if (!error)
                    renderTransactionHash(result)
                else
                    alert(error)
            })
        }, false);

        document.getElementById('connect-instance').addEventListener('click', function() {
            if (!connectInstance(getInstanceHostname(), getInstancePort())) {
                alert('could not connect to ethereum client')
            } else {
                renderGasPriceEstimate()
                getAccounts('sender_address', updateBalances);
                updateBlocks()
                getNetworkGasPrice(renderUserGasPrice)

                unset()
                monitorBlocks()
                document.getElementById('compile-contract').disabled = false
                    // document.getElementById('toggle-mine').disabled = false
                    // document.getElementById('monitor-events').disabled = false
                document.getElementById('send_value').disabled = false
                    // set user gas price once
            }
        }, false);

        document.getElementById('generate-page').addEventListener('click', function() {
            generateDoc()
            if (getContractAddress())
                watchAllEvents()
        }, false);

        // document.getElementById('monitor-events').addEventListener('click', function() {
        //     generateDoc()
        //     if (getContractAddress())
        //         watchAllEvents()
        // }, false);
    }

    window.onbeforeunload = function() {
        // unlikely this fires, but try to clean up after oneself
        unset()
    }
    </script>
</head>

<body>
    <div id="wrapper">
        <div id="head">
            <button type="button" id="connect-instance">Connect</button>
            <samp>geth --rpc --rpcaddr "</samp>
            <input type="text" id="instance-hostname" value="127.0.0.1">
            <samp>" --rpcport "
                <input type="text" id="instance-port" value="8545">" --rpccorsdomain "*" --unlock "&lt;ACCOUNT1&gt; &lt;ACCOUNT2&gt; &lt;ACCOUNT3&gt;"</samp>
        </div>
        <div id="top">
            <div id="local">
                <button type="button" id="compile-contract" disabled>Compile</button>
                <label for="contract-code">Contract</label>
                <br>
                <textarea id="contract-code"></textarea>                
                <button type="button" id="generate-page">Generate</button>
                <label for="contract-abi">Contract ABI</label>
                <br>
                <textarea id="contract-abi"></textarea>
                <!-- <br> -->
                <!-- <button type="button" id="monitor-events" disabled>Monitor</button> -->
            </div>
            <div id="remote">
                <!-- <button type="text" id="toggle-mine" disabled>Mine</button> -->
                <br> Block height: <span id="block-height">?</span>
                <br> Best hash: <span id="block-hash">?</span>
                <br> Estimated gas price: <span id="gas-price">?</span>
                <hr>
                <label for="sender_address">From:</label>
                <select id="sender_address" class="in-address"></select>
                <br> From balance: <span id="sender_balance">0</span>
                <br>
                <label for="contract_address">To:</label>
                <input id="contract_address" type="text" class="in-address">
                <button type="button" id="copy-from">From</button>
                <button type="button" id="copy-receipt">Receipt</button>
                <br>
                <label for="contract_balance">To balance:</label>
                <span id="contract_balance"></span>
                <br>
                <label for="gas">Gas:</label>
                <input id="gas" type="text" class="" value="3000000">
                <br>
                <label for="gas_price">Gas price:</label>
                <input id="gas_price" type="text" class="" value="10">
                <select id="gas_price_unit">
                    <option>ether</option>
                    <option>finney</option>
                    <option selected>szabo</option>
                    <option>shannon</option>
                    <option>babbage</option>
                    <option>ada</option>
                    <option>wei</option>
                </select>
                <button id="gasprice-copy">Sync</button>
                <br>
                <label for="ether_amt">&#926;</label>
                <input id="ether_amt" type="text" value="0">
                <button id="send_value" type="button" disabled>Send</button>
                <br>
                <label for="contract-selector">Deploy contract:</label>
                <select id="contract-selector"></select>
                <button type="button" id="deploy-contract" disabled>Deploy</button>
                <br>
                <label for="transaction-hash">Transaction hash:</label>
                <input id="transaction-hash" type="text" class="in-transaction">
            </div>
        </div>
        <div id="bottom">
            <div id="main">
                <div id="functions"></div>
            </div>
            <div id="status">
                <div id="events"></div>
            </div>
        </div>
        <div id="foot">
        </div>
    </div>
</body>

</html>
