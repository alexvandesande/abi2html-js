<!doctype>
<html>

<head>
    <title>abi2html</title>
    <link rel="stylesheet" href="index.css">
    <script type="text/javascript" src="./dist/bignumber.min.js"></script>
    <script type="text/javascript" src="./dist/web3-light.min.js"></script>
    <script type="text/javascript" src="./lib/abi2html.js"></script>
    <script type="text/javascript">
    var abihtml

    /***

       This is all stuff that Mist should handle, but is included for dev purposes

       ***/

    var testConnection = function(ip, port) {
        if (!ip) ip = '127.0.0.1'
        if (!port) port = '8545'

        if (!web3.currentProvider)
            web3.setProvider(new web3.providers.HttpProvider('http://' + ip + ':' + port));

        try {
            web3.eth.accounts
        } catch (e) {
            console.log(e.toString())
            return false
        }
        return true
    }

    var updateGasprice = function() {
        var gasPrice = web3.eth.gasPrice
        document.getElementById('gasprice-amount').value = web3.fromWei(gasPrice, document.getElementById('gasprice-unit').value)
        document.getElementById('network-gasprice').innerHTML = formattedBalance(gasPrice, document.getElementById('gasprice-unit').value)
    }

    var connectInstance = function() {
        if (!testConnection(document.getElementById('instance-hostname').value, document.getElementById('instance-port').value)) {
            var p = document.createElement('p')
            p.innerHTML = 'Could not connect to Ethereum client'
            makeNotification(p, 'error')
        } else {
            var p = document.createElement('p')
            p.innerHTML = 'Connected'
            makeNotification(p, 'success')

            // set network gas estimate
            updateGasprice()

            // set addresses select
            updateBalances()

            // update block info
            updateWithBlock(web3.eth.getBlock('latest'))

            renderTxCostTotal()

            var filter = web3.eth.filter('latest')
            filter.watch(function(err, result) {
                console.log('Saw new block', result);
                var block = web3.eth.getBlock(result)
                updateWithBlock(block)
                updateBalances()
            })
        }
    }

    var updateWithBlock = function(block) {
        if (block) {
            document.getElementById('block-height').innerHTML = block.number
            document.getElementById('block-hash').innerHTML = block.hash
        }
    }

    var updateBalances = function() {
        var select = document.getElementById('sender-address')
        select.options.length = 0;
        var accounts = web3.eth.accounts
            // accounts.forEach(function(address) {

        for (var i = 0; i < accounts.length; i++) {
            var address = accounts[i]
            var balance = web3.eth.getBalance(address)
            var text = formattedBalance(balance, document.getElementById('value-unit').value)
            var option = document.createElement('option')
            option.value = address
            option.innerHTML = address + ' (' + text + ')'
            select.options.add(option)
        }
    }

    var getTransactionOptions = function() {
        return {
            from: document.getElementById('sender-address').value,
            to: document.getElementById('contract-address').value,
            value: web3.toWei(document.getElementById('value-amount').value, document.getElementById('value-unit').value),
            gas: document.getElementById('gas').value,
            gasPrice: web3.toWei(document.getElementById('gasprice-amount').value, document.getElementById('gasprice-unit').value),
        }
    }

    var renderTxCostTotal = function() {
        var gasunit = document.getElementById('gasprice-unit').value
        var valueunit = document.getElementById('value-unit').value
        var gas = document.getElementById('gas').value
        var gaswei = web3.toWei(document.getElementById('gasprice-amount').value, gasunit)
        var totalwei = gaswei * gas
        var text = formattedBalance(totalwei, valueunit)
        document.getElementById('txcost-total').innerHTML = text
    }

    var formattedBalance = function(weiAmount, unit) {
        return web3.fromWei(weiAmount, unit) + ' ' + unit
    }

    /***

    Convenience functions for this DApp

    ***/

    var generatePage = function() {
        var abi = document.getElementById('contract-abi').value
        var toAddress = document.getElementById('contract-address').value

        var eventCallback = function(htmlDom) {
            makeNotification(htmlDom, 'success')
        }

        var functionCallback = function(htmlDom) {
            var name = htmlDom.childNodes[0].innerHTML
            var li = document.createElement('li')
            var a = document.createElement('a')
            a.href = '#' + name
            a.innerHTML = name
            a.addEventListener('click', function() {
                window.location = a.href
                setSelectedTab()
            }, false)
            li.appendChild(a)
            var ul = document.getElementById('tab-container').children[0]
            ul.appendChild(li)

            htmlDom.style.display = 'none'
            var main = document.getElementById('main-container')
            main.appendChild(htmlDom)
            main.style.display = 'block'
        }

        if (abi) {
            abihtml = new AbiHtml(abi)
            document.getElementById('tab-container').children[0].innerHTML = ''
            for (var name in abihtml.functions) {
                var dom = makeFunction(abihtml.functions[name])
                functionCallback(dom)
            }

            setSelectedTab()

            var opts = getTransactionOptions()
            if (testConnection() && opts.to) {
                for (var name in abihtml.events) {
                    var ev = abihtml.events[name]

                    // ev.Get({
                    //     address: opts.to
                    // }, {}, eventCallback)

                    ev.Watch({
                        address: opts.to
                    }, {}, eventCallback)
                }
            }
        }
    }

    var makeFunction = function(evmFunction) {
        var div = document.createElement('div')
        div.className = ['function'].join(' ')
        div.id = 'function' + evmFunction.name

        var h3 = document.createElement('h3')
        h3.innerHTML = evmFunction.name
        div.appendChild(h3)

        var btn = document.createElement('button')
        btn.type = 'button'
        btn.id = [evmFunction.name, "call"].join(evmFunction.config.idJoinString)
        btn.innerHTML = "Call"
        btn.addEventListener('click', function(ev) {
            evmFunction.Call(getTransactionOptions())
        })
        div.appendChild(btn)

        var tbtn = document.createElement('button')
        tbtn.type = 'button'
        tbtn.id = [evmFunction.name, "transact"].join(evmFunction.config.idJoinString)
        tbtn.innerHTML = "Transact"
        tbtn.addEventListener('click', function(ev) {
            evmFunction.Transact(getTransactionOptions(), function(err, txhash) {
                var p = document.createElement('p')
                if (err) {
                    p.innerHTML = err.toString()
                    makeNotification(p, 'error')
                } else {
                    p.innerHTML = 'Sent transaction: <pre>' + txhash + '</pre>'
                    makeNotification(p)
                }
            })
        })

        div.appendChild(tbtn)

        if (evmFunction.inputs.length > 0) {
            var fs = document.createElement('fieldset')
            fs.className = 'inputs'

            var leg = document.createElement('legend')
            leg.innerHTML = 'Inputs'
            fs.appendChild(leg)

            evmFunction.inputs.forEach(function(field) {
                fs.appendChild(field.renderDom(true))
            })
            div.appendChild(fs)
        }

        if (evmFunction.outputs.length > 0) {
            var fso = document.createElement('fieldset')
            fso.className = 'outputs'

            var leg = document.createElement('legend')
            leg.innerHTML = 'Outputs'
            fso.appendChild(leg)

            evmFunction.outputs.forEach(function(field) {
                fso.appendChild(field.renderDom(false))
            })
            div.appendChild(fso)
        }

        return div
    }


    var sendValue = function() {
        var cb = function(error, result) {
            if (error) {
                var p = document.createElement('p')
                p.innerHTML = error.toString()
                makeNotification(p)
            } else
                renderTransactionHash(result)

        }
        web3.eth.sendTransaction(getTransactionOptions(), cb)
    }

    var makeNotification = function(htmlDom, className) {
        var div = document.createElement('div')
        if (className)
            div.className = className
        var btn = document.createElement('button')
        btn.innerHTML = 'Dismiss'
        btn.addEventListener("click", function() {
            div.style.display = 'none'
        })
        div.appendChild(btn)
        div.appendChild(htmlDom)

        var el = document.getElementById('notifications')
        el.insertBefore(div, el.childNodes[0])
    }

    var displayTab = function(htmlId) {
        var target = document.getElementById('function' + htmlId)
        var parent = document.getElementById('main-container')
        for (var i = 0; i < parent.childNodes.length; i++) {
            var child = parent.childNodes[i]
            if (child.tagName == 'DIV')
                child.style.display = 'none'
        }
        target.style.display = 'block'
    }

    var setSelectedTab = function() {
        var el = document.getElementById('tab-container')
        var x = el.querySelectorAll("ul>li>a")
        for (var i = 0; i < x.length; i++) {
            var item = x[i]
            if (item.href == window.location.href) {
                item.parentNode.className = 'selected'
                var htmlId = item.getAttribute('href').substring(1, item.href.length)
                displayTab(htmlId)
            } else {
                item.parentNode.className = ''
            }
        }

    }

    var setHandlers = function() {
        // set event handlers
        document.getElementById('connect-instance').addEventListener('click', connectInstance, false)
        document.getElementById('gas').addEventListener('keyup', renderTxCostTotal, false)
        document.getElementById('gasprice-amount').addEventListener('keyup', renderTxCostTotal, false)
        document.getElementById('gasprice-copy').addEventListener('click', function() {
            updateGasprice()
            renderTxCostTotal()
        }, false)

        document.getElementById('send-value').addEventListener('click', function() {
            txhash = web3.eth.sendTransaction(getTransactionOptions())

            // // below doesn't work because it doens't wait for it to be mined
            // web3.eth.getTransactionReceipt(txhash, function(err, txReceipt) {
            //     console.log(err, txReceipt)
            // })

            var p = document.createElement('p')
            p.innerHTML = 'Sent transaction: <pre>' + txhash + '</pre>'
            makeNotification(p)
        }, false)

        document.getElementById('copy-from').addEventListener('click', function() {
            var address = document.getElementById('sender-address').value
            document.getElementById('contract-address').value = address
                // document.getElementById('contract-balance').innerHTML = formattedBalance(web3.eth.getBalance(address), document.getElementById('value-unit').value)
        }, false)

        document.getElementById('sender-address').addEventListener('change', function() {
            var accounts = abihtml.GetAccounts(true)
            var wei = accounts[document.getElementById('sender-address').value]
            var unit = document.getElementById('gasprice-unit').value
            var text = web3.fromWei(wei, unit).toString() + ' ' + unit
            document.getElementById('sender-balance').value = text
        }, false);



        document.getElementById('value-unit').addEventListener('change', function() {
            updateBalances()
            renderTxCostTotal()
                // var address = document.getElementById('contract-address').value
                // if (address)
                //     document.getElementById('contract-balance').innerHTML = formattedBalance(web3.eth.getBalance(address), document.getElementById('value-unit').value)
                // else
                //     document.getElementById('contract-balance').innerHTML = ''
        }, false)

        document.getElementById('gasprice-unit').addEventListener('change', function() {
            // below will override the number part, which is ugly
            // this also requires us to update the maximum cost
            updateGasprice()
            renderTxCostTotal()
        }, false)

        document.getElementById('compile-contract').addEventListener('click', function() {
            compileSolidity(document.getElementById('contract-code').value, function(err, result) {
                if (err) {
                    var p = document.createElement('p')
                    p.innerHTML = err.toString()
                    makeNotification(p, 'error')
                } else {
                    contracts = result
                    setContractSelector('contract-selector', result)
                    renderContractInfo('contract-abi', getSelectedContract('contract-selector'))
                    generateDoc();
                    document.getElementById('deploy-contract').disabled = false
                    if (getContractAddress())
                        watchAllEvents()
                }
            })

        }, false);

        document.getElementById('contract-selector').addEventListener('change', function() {
            renderContractInfo('contract-abi', getSelectedContract('contract-selector'))
            unset()
            generateDoc();
            watchAllEvents();
        })

        document.getElementById('deploy-contract').addEventListener('click', function() {
            userContract = getSelectedContract('contract-selector')
            contract = deployContract(userContract.code, function(error, result) {
                    if (!error) {
                        console.log('Contract mined:', result)
                        renderTransactionHash(contract.transactionHash)
                        document.getElementById('contract-address').value = result.address
                    } else {
                        var p = document.createElement('p')
                        p.innerHTML = error.toString()
                        makeNotification(p, 'success')
                    }
                })
                // run a few milliseconds later since transaction hash isn't available immediately
            setTimeout(function() {
                console.log(contract)
                if (contract.transactionHash)
                    renderTransactionHash(contract.transactionHash)
            }, 100)

        }, false)



        document.getElementById('generate-page').addEventListener('click', generatePage, false)

    }

    window.onload = function() {
        connectInstance()
        setHandlers()
        if (document.getElementById('contract-abi').value) {
            generatePage()
        }

    }
    </script>
</head>

<body>
    <div id="header">
        <div id="header-wrapper">
            <div id="node">
                <button type="button" id="connect-instance">Connect</button>
                <samp>geth --rpc --rpcaddr "</samp>
                <input type="text" id="instance-hostname" value="127.0.0.1">
                <samp>" --rpcport "
                    <input type="text" id="instance-port" value="8545">" --rpccorsdomain "*" --unlock "&lt;ACCOUNT1&gt; &lt;ACCOUNT2&gt; &lt;ACCOUNT3&gt;"
                </samp>
                <p>
                    Block height: <span id="block-height">?</span> Best hash: <span id="block-hash">?</span> Estimated gas price: <span id="network-gasprice">?</span>
                </p>
            </div>
            <div id="dashboard">
                <div id="contract">
                    <label for="contract-code">Contract</label>
                    <button type="button" id="compile-contract" disabled>Compile to ABI</button>
                    <br>
                    <textarea id="contract-code"></textarea>
                </div>
                <div id="abi">
                    <label for="contract-abi">Contract ABI</label>
                    <button type="button" id="generate-page">Generate Form</button>
                    <br>
                    <textarea id="contract-abi">[{"constant":false,"inputs":[{"name":"_owner","type":"address"}],"name":"removeOwner","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"_addr","type":"address"}],"name":"isOwner","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[],"name":"m_numOwners","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[],"name":"resetSpentToday","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"_owner","type":"address"}],"name":"addOwner","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"m_required","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"_h","type":"bytes32"}],"name":"confirm","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"_newLimit","type":"uint256"}],"name":"setDailyLimit","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"},{"name":"_data","type":"bytes"}],"name":"execute","outputs":[{"name":"_r","type":"bytes32"}],"type":"function"},{"constant":false,"inputs":[{"name":"_operation","type":"bytes32"}],"name":"revoke","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"_newRequired","type":"uint256"}],"name":"changeRequirement","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"_operation","type":"bytes32"},{"name":"_owner","type":"address"}],"name":"hasConfirmed","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"}],"name":"kill","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"}],"name":"changeOwner","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"m_dailyLimit","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"inputs":[{"name":"identifier","type":"bytes32"}],"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"name":"identifier","type":"bytes32"}],"name":"Created","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"owner","type":"address"},{"indexed":false,"name":"operation","type":"bytes32"}],"name":"Confirmation","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"owner","type":"address"},{"indexed":false,"name":"operation","type":"bytes32"}],"name":"Revoke","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"oldOwner","type":"address"},{"indexed":false,"name":"newOwner","type":"address"}],"name":"OwnerChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"newOwner","type":"address"}],"name":"OwnerAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"oldOwner","type":"address"}],"name":"OwnerRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"newRequirement","type":"uint256"}],"name":"RequirementChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"from","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Deposit","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"owner","type":"address"},{"indexed":false,"name":"value","type":"uint256"},{"indexed":false,"name":"to","type":"address"},{"indexed":false,"name":"data","type":"bytes"}],"name":"SingleTransact","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"owner","type":"address"},{"indexed":false,"name":"operation","type":"bytes32"},{"indexed":false,"name":"value","type":"uint256"},{"indexed":false,"name":"to","type":"address"},{"indexed":false,"name":"data","type":"bytes"}],"name":"MultiTransact","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"operation","type":"bytes32"},{"indexed":false,"name":"initiator","type":"address"},{"indexed":false,"name":"value","type":"uint256"},{"indexed":false,"name":"to","type":"address"},{"indexed":false,"name":"data","type":"bytes"}],"name":"ConfirmationNeeded","type":"event"}]</textarea>
                    <!-- <br> -->
                    <!-- <button type="button" id="monitor-events" disabled>Monitor</button> -->
                </div>
                <div id="controls">
                    <label for="sender-address">From:</label>
                    <select id="sender-address" class="in-address"></select>
                    <button type="button" id="copy-from">Copy To</button>
                    <label for="contract-address">To:</label>
                    <input id="contract-address" type="text" class="in-address" value="0x63f33b08404987648ce2dde79715e14e8b69e4d8">
                    <!-- <label for="contract-balance">Balance:</label> -->
                    <!-- <span id="contract-balance"></span> -->
                    <label for="value-amount">Value</label>
                    <input id="value-amount" type="text" value="0.01">
                    <select id="value-unit">
                        <option selected="">ether</option>
                        <option>finney</option>
                        <option>szabo</option>
                        <option>shannon</option>
                        <option>babbage</option>
                        <option>ada</option>
                        <option>wei</option>
                    </select>
                    <label for="gas">Gas:</label>
                    <input id="gas" type="text" class="" value="3000000">
                    <label for="gas-price">Gas price:</label>
                    <input id="gasprice-amount" type="text" class="" value="10">
                    <select id="gasprice-unit">
                        <option>ether</option>
                        <option>finney</option>
                        <option selected>szabo</option>
                        <option>shannon</option>
                        <option>babbage</option>
                        <option>ada</option>
                        <option>wei</option>
                    </select>
                    <button id="gasprice-copy">Sync estimate</button>
                    <span>Max cost: <span id="txcost-total">?</span></span>
                    <button id="send-value" type="button">Send</button>
                    <label for="contract-selector">Deploy contract:</label>
                    <select id="contract-selector"></select>
                    <button type="button" id="deploy-contract" disabled>Deploy</button>
                </div>
            </div>
        </div>
    </div>
    <div id="main">
        <div id="functions">
            <h2>Actions</h2>
            <div id="tab-container">
                <ul>
                </ul>
            </div>
            <div id="main-container">
            </div>
        </div>
        <div id="events">
            <h2>Notifications</h2>
            <div id="notifications"></div>
        </div>
    </div>
    <div id="footer">
    </div>
</body>

</html>
