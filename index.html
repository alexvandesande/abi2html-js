<!doctype>
<html>

<head>
    <title>abi2html</title>
    <link rel="stylesheet" href="index.css">
    <script type="text/javascript" src="./dist/bignumber.min.js"></script>
    <script type="text/javascript" src="./dist/web3-light.min.js"></script>
    <script type="text/javascript" src="./lib/abi2html.js"></script>
    <script type="text/javascript">
    var loadedAbihtml = []
        /***

        This is all stuff that Mist should handle, but is included for dev purposes

        ***/

    var testConnection = function(ip, port) {
        if (!ip) ip = '127.0.0.1'
        if (!port) port = '8545'

        if (!web3.currentProvider)
            web3.setProvider(new web3.providers.HttpProvider('http://' + ip + ':' + port))
        try {
            web3.eth.accounts
        } catch (e) {
            // console.log(e.toString())
            return false
        }
        return true
    }

    var connectInstance = function() {
        if (!testConnection(document.getElementById('instance-hostname').value, document.getElementById('instance-port').value)) {
            displayNotification('Could not connect to Ethereum client', 'error')
        } else {
            displayNotification('Connected', 'success')
            document.getElementById('compile-contract').disabled = false
            document.getElementById('deploy-contract').disabled = false
            document.getElementById('send-value').disabled = false
            document.getElementById('gasprice-copy').disabled = false
            document.getElementById('copy-from').disabled = false
        }
    }

    var watchBlocks = function() {
        displayNotification('Watching incoming blocks')
        var filter = web3.eth.filter('latest')
        if (!filter)
            displayNotification('Problem creating filter', 'warning')
        else
            filter.watch(function(err, result) {
                // console.log('Saw new block', result)
                var block = web3.eth.getBlock(result)
                updateWithBlock(block)
                updateBalances()
            })
    }

    var getTransactionOptions = function() {
        return {
            from: document.getElementById('sender-address').value,
            to: document.getElementById('contract-address').value,
            value: web3.toWei(document.getElementById('value-amount').value, document.getElementById('value-unit').value),
            gas: document.getElementById('gas').value,
            gasPrice: web3.toWei(document.getElementById('gasprice-amount').value, document.getElementById('gasprice-unit').value),
        }
    }

    var getEventOptions = function() {
        var txopts = getTransactionOptions()
        return {
            address: txopts.to
        }
    }

    /***

    Convenience functions for this DApp

    ***/

    var callAjax = function(url, callback) {
        var xmlhttp
            // compatible with IE7+, Firefox, Chrome, Opera, Safari
        xmlhttp = new XMLHttpRequest()
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                callback(xmlhttp.responseText)
            }
        }
        xmlhttp.open("GET", url, true)
        xmlhttp.send()
    }

    var getParameterByName = function(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]")
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
            results = regex.exec(location.search)
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "))
    }

    var formattedBalance = function(weiAmount, unit) {
        return web3.fromWei(weiAmount, unit) + ' ' + unit
    }


    var loadSolidityGist = function(response, callback) {
        result = JSON.parse(response)
        if (result) {
            for (var f in result.files) {
                var content = result.files[f].content

                document.getElementById('contract').style.display = 'block'
                document.getElementById('contract-code').value = content

                document.getElementById('abi').style.display = 'none'
                document.getElementById('contract-abi').value = ''

                document.getElementById('tab-container').children[0].innerHTML = ''

                if (typeof callback === "function")
                    callback(content)

                break //only support first file
            }
        }
    }

    var loadAbiGist = function(response, callback) {
        result = JSON.parse(response)
        if (result) {
            for (var f in result.files) {
                var content = result.files[f].content


                document.getElementById('contract').style.display = 'none'
                document.getElementById('contract-code').value = ''

                document.getElementById('abi').style.display = 'block'
                document.getElementById('contract-abi').value = content

                document.getElementById('tab-container').children[0].innerHTML = ''

                if (typeof callback === "function")
                    callback(content)

                break //only support first file
            }
        }
    }

    var compileContract = function(code, callback) {
        if (!code) code = document.getElementById('contract-code').value
        if (!callback) callback = updatePageWithContract

        // this could be improved to handle multiple compilers
        if (code)
            compileSolidity(code, function(err, results) {
                if (err) {
                    displayNotification(err.toString(), 'error')
                } else {
                    if (typeof callback === "function")
                        callback(results)
                }
            })
    }

    var compileSolidity = function(sourceString, callback) {
        var c = web3.eth.getCompilers()
        var i = 0
        for (; i < c.length; i++) {
            if (c[i] == 'Solidity')
                break
        }
        if (i < c.length) {
            web3.eth.compile.solidity(sourceString, callback)
        } else {
            displayNotification('Solidity compiler not available', 'warning')
        }
    }


    var deployContract = function(callback) {
        var select = document.getElementById('contract-selector')
        var userContract = JSON.parse(select.options[select.selectedIndex].value)

        var options = getTransactionOptions()
        options.data = userContract.code
        web3.eth.contract(userContract.info.abiDefinition).new(options, callback)
    }


    /***

    Interface updating

    ***/

    var updatePageWithSource = function(source) {
        compileContract(source, function(contractData) {
            updatePageWithContract(contractData)
            var abiSource = document.getElementById('contract-abi').value
            var abihtml = new AbiHtml(abiSource)
            if (abihtml) {
                makeFunctionForm(abihtml)
                updateEventList(abihtml)
                abihtml.GetEventLogs(getEventOptions(), true, function(evmEvent) {
                    makeEventNotification(evmEvent, displayNotification)
                })
                return abihtml
            }
        })

    }

    var updateDashboard = function() {
        // set network gas estimate
        updateGasprice()

        // set addresses select
        updateBalances()

        // update block info
        updateWithBlock(web3.eth.getBlock('latest'))

        // show maximum cost of transaction
        updateMaxTxCost()

        updateToBalance()

    }


    var updateGasprice = function() {
        var gasPrice = web3.eth.gasPrice
        document.getElementById('gasprice-amount').value = web3.fromWei(gasPrice, document.getElementById('gasprice-unit').value)
        document.getElementById('network-gasprice').innerHTML = formattedBalance(gasPrice, document.getElementById('gasprice-unit').value)
    }


    var updateWithBlock = function(block) {
        if (block) {
            document.getElementById('block-height').innerHTML = block.number
            document.getElementById('block-hash').innerHTML = block.hash
        }
    }

    var updateBalances = function() {
        var select = document.getElementById('sender-address')
        select.options.length = 0
        var accounts = web3.eth.accounts
            // accounts.forEach(function(address) {

        for (var i = 0; i < accounts.length; i++) {
            var address = accounts[i]
            var balance = web3.eth.getBalance(address)
            var text = formattedBalance(balance, document.getElementById('value-unit').value)
            var option = document.createElement('option')
            option.value = address
            option.innerHTML = address + ' (' + text + ')'
            select.options.add(option)
        }
    }

    var updateToBalance = function() {
        var address = document.getElementById('contract-address').value
        if (address) {
            try {
                var balance = web3.eth.getBalance(address)
                if (balance)
                    document.getElementById('contract-balance').innerHTML = formattedBalance(balance, document.getElementById('value-unit').value)
            } catch (e) {
                document.getElementById('contract-balance').innerHTML = ''
            }
        } else {
            document.getElementById('contract-balance').innerHTML = ''
        }
    }


    var updateMaxTxCost = function() {
        var gas = document.getElementById('gas').value
        var gaspriceWei = web3.toWei(document.getElementById('gasprice-amount').value, document.getElementById('gasprice-unit').value)
        var totalwei = gaspriceWei * gas
        var text = formattedBalance(totalwei, document.getElementById('value-unit').value)
        document.getElementById('txcost-total').innerHTML = text
    }

    var sortEvents = function(callback) {
        // get sort values from DOM
        var sortDom = document.getElementById('eventSorter')
        var fs = sortDom.querySelector('fieldset')
        var filterFields = {}
        for (var i = 0; i < fs.children.length; i++) {
            var child = fs.children[i]
            if (child.tagName == 'DIV') {

                var label = child.querySelector("label.name")
                var select = child.querySelector("select.comparison")
                var input = child.querySelector("input.value")
                filterFields[label.innerHTML] = {
                    name: label.innerHTML,
                    value: input.value,
                    operator: select.value
                }
            }
        }

        // get get log fields
        var parent = document.getElementById('notifications')
        for (var i = 0; i < parent.children.length; i++) {
            var wrap = parent.children[i]

            // build object from output for comparison
            var fs = wrap.querySelector('fieldset.inputs')
            var logFields = {}
            for (var j = 0; j < fs.children.length; j++) {
                var child = fs.children[j]
                if (child.tagName == 'DIV') {
                    var label = child.querySelector("label.name")
                    var input = child.querySelector("input.value")
                    logFields[label.innerHTML] = input.value
                }
            }



            // check filterFields for corresponding logFields
            var matches = true
            for (k in filterFields) {
                var obj = filterFields[k]
                var name = obj.name
                var compValue = obj.operator
                if (name in logFields) {
                    var fieldValue = obj.value
                    var logValue = logFields[obj.name]

                    // do comparison tests
                    switch (obj.operator) {
                        case '!=':
                        case '<>':
                            if (logValue == fieldValue) matches = false
                            break
                        case '=':
                            if (logValue != fieldValue) matches = false
                            break
                        case '>':
                            if (logValue <= fieldValue) matches = false
                            break
                        case '>=':
                            if (logValue < fieldValue) matches = false
                            break
                        case '<':
                            if (logValue >= fieldValue) matches = false
                            break
                        case '<=':
                            if (logValue > fieldValue) matches = false
                            break
                        case '*':
                        case '':
                            // noop
                            break
                        default:
                            console.log('Unknown comparison', argComp)
                    }
                }
            }

            if (matches) wrap.style.display = 'block'
            else wrap.style.display = 'none'


        }

        if (typeof callback === "function") callback()
    }


    var filterEventTopics = function(evmEvent, filterFields, callback) {
        if (!filterFields) filterFields = {}

        var options = getTransactionOptions()
            // clearNotifications()
        evmEvent.Get(getEventOptions(), filterFields, callback)
    }

    var updatePageWithContract = function(results) {
        // update contract selector
        select = document.getElementById('contract-selector')
        select.options.length = 0
        for (var k in results) {
            var obj = results[k]
            var el = document.createElement('option')
            el.textContent = k
            el.value = JSON.stringify(results[k])
            select.options.add(el)
        }

        // set index && display abi
        select.selectedIndex = 0
        var userContract = JSON.parse(select.options[0].value)

        document.getElementById('contract-abi').value = JSON.stringify(userContract.info.abiDefinition)
        document.getElementById('contract-selector').disabled = false
        document.getElementById('deploy-contract').disabled = false
    }


    var displayTab = function(htmlId) {
        var target = document.getElementById('function' + htmlId)
        var parent = document.getElementById('main-container')
        for (var i = 0; i < parent.childNodes.length; i++) {
            var child = parent.childNodes[i]
            if (child.tagName == 'DIV')
                child.style.display = 'none'
        }
        target.style.display = 'block'
    }

    var setSelectedTab = function() {
        var el = document.getElementById('tab-container')
        var x = el.querySelectorAll("ul>li>a")
        for (var i = 0; i < x.length; i++) {
            var item = x[i]
            if (item.href == window.location.href) {
                item.parentNode.className = 'selected'
                var htmlId = item.getAttribute('href').substring(1, item.href.length)
                displayTab(htmlId)
            } else {
                item.parentNode.className = item.parentNode.className.replace('selected', '')
            }
        }

    }

    var clearNotifications = function() {
        document.getElementById('notifications').innerHTML = ''
        document.getElementById('eventFilter').innerHTML = ''
    }

    var resetEventList = function() {
        document.getElementById('event-list').selectedIndex = 0
    }


    var displayNotification = function(obj, className) {
        var htmlDom
        if (typeof obj === "object" && "nodeType" in obj) {
            // looks like HTML Element
            htmlDom = obj
        } else if (typeof obj === "string") {
            // looks like string
            var htmlDom = document.createElement('p')
            htmlDom.innerHTML = obj
        }

        var parElement = document.createElement('div')
        if (className)
            parElement.className = className
        var btn = document.createElement('button')
        btn.innerHTML = 'Dismiss'
        btn.addEventListener("click", function() {
            parElement.style.display = 'none'
        })

        parElement.appendChild(btn)
        parElement.appendChild(htmlDom)

        // append the entry and the top
        var el = document.getElementById('notifications')
        el.insertBefore(parElement, el.childNodes[0])

    }

    var displayEventFilter = function(obj, className) {
        var htmlDom
        if (typeof obj === "object" && "nodeType" in obj) {
            // looks like HTML Element
            htmlDom = obj
        } else if (typeof obj === "string") {
            // looks like string
            var htmlDom = document.createElement('p')
            htmlDom.innerHTML = obj
        }

        var existing = document.getElementById('eventFilter')
        if (existing) {
            existing.innerHTML = ''
            existing.appendChild(htmlDom)
        } else {
            var parElement = document.createElement('div')
            parElement.id = 'eventFilter'
            if (className)
                parElement.className = className
            parElement.appendChild(htmlDom)
                // append the entry and the top
            var el = document.getElementById('events')
            el.insertBefore(parElement, el.children[el.children.length - 1])

        }



    }


    var updateEventList = function(abihtml) {
        var select = document.getElementById('event-list')
        select.options.length = 0

        var first = document.createElement('option')
        first.textContent = '<none>'
        first.value = ''
        select.options.add(first)

        for (var name in abihtml.events) {
            var el = document.createElement('option')
            el.textContent = name
            el.value = name
            select.options.add(el)
        }

        var last = document.createElement('option')
        last.textContent = '<all>'
        last.value = '*'
        select.options.add(last)

        select.selectedIndex = 0

    }



    /***

    Object factories

    **/



    var makeFunctionForm = function(abihtml) {
        if (!abihtml)
            abihtml = new AbiHtml(document.getElementById('contract-abi').value)

        if (abi) {
            document.getElementById('tab-container').children[0].innerHTML = ''

            var funcs = abihtml.GetFunctionsSorted()

            funcs.forEach(function(f) {
                var dom = makeFunction(abihtml.functions[f.name])
                makeNav(dom, abihtml.functions[f.name])
            })

            setSelectedTab()
        }
    }

    var makeEventTopicFilter = function(evmEvent, cb) {
        if (!evmEvent) return

        // containing div element
        var div = document.createElement('div')
        div.className = ['event'].join(' ')
        div.id = 'eventTopicFilter' + evmEvent.name

        var h3 = document.createElement('h3')
        h3.innerHTML = evmEvent.name
        div.appendChild(h3)

        if (evmEvent.inputs.length > 0) {
            var fs = document.createElement('fieldset')
            fs.className = 'inputs'

            var leg = document.createElement('legend')
            leg.innerHTML = 'Fields'
            fs.appendChild(leg)


            // append the DOM for each field to the fieldset
            for (var i = 0; i < evmEvent.inputs.length; i++) {
                var field = evmEvent.inputs[i]
                field.setHtmlId(div.id + field.getHtmlId())

                if (field.indexed)
                    fs.appendChild(field.renderDom(true))
                else
                    fs.appendChild(field.renderDom(false))
            }

            // callback to get filter fields
            var button = document.createElement('button')
            button.innerHTML = 'Filter'
            button.addEventListener('click', function() {
                var filterFields = {}
                for (k in evmEvent.inputs) {
                    var field = evmEvent.inputs[k]
                    var val = document.getElementById(field.getHtmlId()).value
                    if (val) filterFields[field.getName()] = val
                }
                clearNotifications()
                makeLocalEventSorter(evmEvent, displayEventFilter)
                filterEventTopics(evmEvent, filterFields, function(evmEvent) {
                    makeEventLog(evmEvent, function(dom) {
                        displayNotification(dom)
                    })

                })

            })

            div.appendChild(button)
            div.appendChild(fs)

        }

        if (typeof cb === "function")
            cb(div)

        return div


    }

    var makeLocalEventSorter = function(evmEvent, cb) {
        if (!evmEvent) return

        // containing div element
        var div = document.createElement('div')
        div.className = ['event'].join(' ')
        div.id = 'eventSorter'

        var h3 = document.createElement('h3')
        h3.innerHTML = evmEvent.name
        div.appendChild(h3)

        if (evmEvent.inputs.length > 0) {
            var fs = document.createElement('fieldset')
            fs.className = 'inputs'

            var leg = document.createElement('legend')
            leg.innerHTML = 'Fields'
            fs.appendChild(leg)


            // append the DOM for each field to the fieldset
            for (var i = 0; i < evmEvent.inputs.length; i++) {
                var field = evmEvent.inputs[i]
                field.setHtmlId(div.id + field.getHtmlId())
                var wrap = document.createElement('div')
                wrap.className = 'solfield'
                wrap.appendChild(field.RenderLabel())


                // TODO this does not take into account types
                // Numbers as strings sort wrong
                var select = document.createElement('select')
                select.className = 'comparison'
                var option = document.createElement('option')
                option.innerHTML = '(all)'
                option.value = '*'
                select.options.add(option)
                var option = document.createElement('option')
                option.innerHTML = '>'
                option.value = '>'
                select.options.add(option)
                var option = document.createElement('option')
                option.innerHTML = '>='
                option.value = '>='
                select.options.add(option)
                var option = document.createElement('option')
                option.innerHTML = '='
                option.value = '='
                select.options.add(option)
                var option = document.createElement('option')
                option.innerHTML = '<'
                option.value = '<'
                select.options.add(option)
                var option = document.createElement('option')
                option.innerHTML = '<='
                option.value = '<='
                select.options.add(option)
                var option = document.createElement('option')
                option.innerHTML = '<>'
                option.value = '<>'
                select.options.add(option)

                select.selectedIndex = 0
                wrap.appendChild(select)
                wrap.appendChild(field.RenderField(true))

                fs.appendChild(wrap)
            }


            // callback to get filter fields
            var button = document.createElement('button')
            button.innerHTML = 'Sorter'
            button.addEventListener('click', function() {
                sortEvents()
            })

            div.appendChild(button)
            div.appendChild(fs)

        }

        if (typeof cb === "function")
            cb(div)

        return div


    }

    var makeEventLog = function(evmEvent, cb) {
        var div = document.createElement('div')
        div.className = ['event'].join(' ')
        div.id = 'event' + evmEvent.name

        var h3 = document.createElement('h3')
        h3.innerHTML = evmEvent.name
        div.appendChild(h3)

        if (evmEvent.err) {
            var p = document.createElement('p')
            p.innerHTML = evmEvent.err.toString()
            div.appendChild(p)
        } else {
            var receipt = web3.eth.getTransactionReceipt(evmEvent.results.transactionHash)
            var dl = document.createElement('dl')

            var dtAddress = document.createElement('dt')
            var ddAddress = document.createElement('dd')

            dtAddress.innerHTML = 'Contract:'
            ddAddress.innerHTML = evmEvent.results.address
            dl.appendChild(dtAddress)
            dl.appendChild(ddAddress)


            var dtHash = document.createElement('dt')
            var ddHash = document.createElement('dd')

            dtHash.innerHTML = 'Transaction hash:'
            dl.appendChild(dtHash)

            ddHash.innerHTML = evmEvent.results.transactionHash
            dl.appendChild(ddHash)

            var dtGas = document.createElement('dt')
            var ddGas = document.createElement('dd')

            dtGas.innerHTML = 'Gas used:'
            dl.appendChild(dtGas)

            ddGas.innerHTML = receipt.gasUsed
            dl.appendChild(ddGas)

            div.appendChild(dl)

            if (evmEvent.inputs.length > 0) {
                var fs = document.createElement('fieldset')
                fs.className = 'inputs'

                var leg = document.createElement('legend')
                leg.innerHTML = 'Fields'
                fs.appendChild(leg)


                // append the DOM for each field to the fieldset
                for (var i = 0; i < evmEvent.inputs.length; i++) {
                    var field = evmEvent.inputs[i]

                    // if we have a value for a given field, render it
                    if (evmEvent.results && "args" in evmEvent.results && field.getName() in evmEvent.results.args)
                        fs.appendChild(field.renderDom(false, evmEvent.results.args[field.getName()]))
                    else
                        fs.appendChild(field.renderDom(false))
                }
                div.appendChild(fs)
            }

        }

        if (typeof cb === "function") cb(div)
        return div
    }


    var makeEventNotification = function(evmEvent, cb) {
        // containing div element
        var div = document.createElement('div')
        div.className = ['event'].join(' ')
        div.id = 'eventLog' + evmEvent.name

        if (evmEvent.err) {
            var p = document.createElement('p')
            p.innerHTML = evmEvent.err.toString()
            div.appendChild(p)
        } else {

            var h3 = document.createElement('h3')
            h3.innerHTML = evmEvent.name
            div.appendChild(h3)

            var receipt = web3.eth.getTransactionReceipt(evmEvent.results.transactionHash)
            var dl = document.createElement('dl')

            var dtAddress = document.createElement('dt')
            var ddAddress = document.createElement('dd')

            dtAddress.innerHTML = 'Contract:'
            ddAddress.innerHTML = evmEvent.results.address
            dl.appendChild(dtAddress)
            dl.appendChild(ddAddress)


            var dtHash = document.createElement('dt')
            var ddHash = document.createElement('dd')

            dtHash.innerHTML = 'Transaction hash:'
            dl.appendChild(dtHash)

            ddHash.innerHTML = evmEvent.results.transactionHash
            dl.appendChild(ddHash)

            var dtGas = document.createElement('dt')
            var ddGas = document.createElement('dd')

            dtGas.innerHTML = 'Gas used:'
            dl.appendChild(dtGas)

            ddGas.innerHTML = receipt.gasUsed
            dl.appendChild(ddGas)

            div.appendChild(dl)

            if (evmEvent.inputs.length > 0) {
                var fs = document.createElement('fieldset')
                fs.className = 'inputs'

                var leg = document.createElement('legend')
                leg.innerHTML = 'Fields'
                fs.appendChild(leg)


                // append the DOM for each field to the fieldset
                for (var i = 0; i < evmEvent.inputs.length; i++) {
                    var field = evmEvent.inputs[i]
                    fs.appendChild(field.renderDom(false))
                }
                div.appendChild(fs)
            }
        }

        if (typeof cb === "function")
            cb(div)

        return div


    }

    var makeNav = function(htmlDom, evmFunction) {
        var name = htmlDom.childNodes[0].innerHTML
        var li = document.createElement('li')
        var a = document.createElement('a')
        if (evmFunction.outputs.length > 0)
            a.className += ' call'
        if (!evmFunction.constant)
            a.className += ' transact'
        a.href = '#' + name
        a.innerHTML = name
        a.addEventListener('click', function() {
            window.location = a.href
            setSelectedTab()
        }, false)
        li.appendChild(a)

        var ul = document.getElementById('tab-container').children[0]
        ul.appendChild(li)

        htmlDom.style.display = 'none'
        var main = document.getElementById('main-container')
        main.appendChild(htmlDom)
        main.style.display = 'block'
    }

    var makeFunction = function(evmFunction) {
        var div = document.createElement('div')
        div.className = ['function'].join(' ')
        div.id = 'function' + evmFunction.name

        var h3 = document.createElement('h3')
        h3.innerHTML = evmFunction.name
        div.appendChild(h3)

        if (evmFunction.outputs.length > 0) {
            var btn = document.createElement('button')
            btn.type = 'button'
            btn.id = [evmFunction.name, "call"].join(evmFunction.config.idJoinString)
            btn.innerHTML = "Call"
            btn.addEventListener('click', function(ev) {
                evmFunction.Call(getTransactionOptions())
            })
            div.appendChild(btn)
        }

        if (!evmFunction.constant) {
            var tbtn = document.createElement('button')
            tbtn.type = 'button'
            tbtn.id = [evmFunction.name, "transact"].join(evmFunction.config.idJoinString)
            tbtn.innerHTML = "Transact"
            tbtn.addEventListener('click', function(ev) {
                evmFunction.Transact(getTransactionOptions(), function(err, txhash) {
                    if (err) {
                        displayNotification(err.toString(), 'error')
                    } else {
                        displayNotification('Sent transaction: <pre>' + txhash + '</pre>', 'warning')
                    }
                })
            })
            div.appendChild(tbtn)
        }



        if (evmFunction.inputs.length > 0) {
            var fs = document.createElement('fieldset')
            fs.className = 'inputs'

            var leg = document.createElement('legend')
            leg.innerHTML = 'Inputs'
            fs.appendChild(leg)

            evmFunction.inputs.forEach(function(field) {
                fs.appendChild(field.renderDom(true))
            })
            div.appendChild(fs)
        }

        if (evmFunction.outputs.length > 0) {
            var fso = document.createElement('fieldset')
            fso.className = 'outputs'

            var leg = document.createElement('legend')
            leg.innerHTML = 'Outputs'
            fso.appendChild(leg)

            evmFunction.outputs.forEach(function(field) {
                fso.appendChild(field.renderDom(false))
            })
            div.appendChild(fso)
        }

        return div
    }

    var makeContractNotification = function(result) {
        // get transaction to see if it's been mined
        var transaction = web3.eth.getTransaction(result.transactionHash)

        // if no blockhash, set a timer and try later
        if (!transaction.blockHash) {
            setTimeout(function() {
                makeContractNotification(result)
            }, 5000)
            return
        }

        // if we have a blockhash, we should find a receipt
        var receipt = web3.eth.getTransactionReceipt(result.transactionHash, function(error, receipt) {
            // if no address found, inform the user
            if (!receipt.contractAddress) {
                console.log('*** This should have a contractAddress', receipt)
                var text = 'Contract in transaction <pre>' + result.transactionHash + '</pre> mined in block <pre>' + transaction.blockHash + '</pre>  (height ' + transaction.blockNumber + ') but receipt has no creation address'
                displayNotification(text, 'error')
                return
            }

            var dl = document.createElement('dl')
            var dtHeight = document.createElement('dt')
            var ddHeight = document.createElement('dd')

            dtHeight.innerHTML = 'Block number:'
            ddHeight.innerHTML = receipt.blockNumber

            dl.appendChild(dtHeight)
            dl.appendChild(ddHeight)

            var dtAddress = document.createElement('dt')
            var ddAddress = document.createElement('dd')

            dtAddress.innerHTML = 'New address:'
            dl.appendChild(dtAddress)

            ddAddress.innerHTML = receipt.contractAddress
            dl.appendChild(ddAddress)

            var dtGas = document.createElement('dt')
            var ddGas = document.createElement('dd')

            dtGas.innerHTML = 'Gas used:'
            dl.appendChild(dtGas)

            ddGas.innerHTML = receipt.gasUsed
            dl.appendChild(ddGas)

            displayNotification(dl, 'success')
            document.getElementById('contract-address').value = receipt.contractAddress
        })
    }

    /***

    Loading

    ***/

    window.onload = function() {
        var solGistId = getParameterByName('SOLIDITY_GIST')
        var abiGistId = getParameterByName('ABI_GIST')
        var toAddress = getParameterByName('TO_ADDRESS')

        // defaults
        if (!solGistId && !abiGistId) {
            if (window.location.protocol === "file:") {
                // debug
                solGistId = "c835f38889b989e8488c"
                toAddress = "0x63f33b08404987648ce2dde79715e14e8b69e4d8"
            } else if (window.location.host === 'tgerring.github.io') {
                // public
                abiGistId = "0e1b884de82d35053a34"
                toAddress = "0x21a3a128968f7fd17eb0a16045a84769374aeae0"
            }
        }

        if (toAddress) document.getElementById('contract-address').value = toAddress
        setHandlers()

        if (abiGistId) {
            displayNotification('Loading ABI with Gist ID ' + abiGistId)
            callAjax('https://api.github.com/gists/' + abiGistId, function(response) {
                loadAbiGist(response, function(abiSource) {

                    var abihtml = new AbiHtml(abiSource)
                    if (abihtml) {
                        loadedAbihtml[0] = abihtml
                        makeFunctionForm(abihtml)
                        updateEventList(abihtml)
                    }

                    connectInstance()
                    if (testConnection()) {
                        updateDashboard()
                        watchBlocks()
                        abihtml.GetEventLogs(getEventOptions(), true, function(evmEvent) {
                            makeEventNotification(evmEvent, displayNotification)
                        })
                    }
                })
            })
        } else if (solGistId) {
            displayNotification('Loading Solidity with Gist ID ' + solGistId)
            connectInstance()
            callAjax('https://api.github.com/gists/' + solGistId, function(response) {
                loadSolidityGist(response, function(solSource) {
                    if (testConnection()) {
                        updateDashboard()
                        watchBlocks()
                        compileContract(solSource, function(contractData) {
                            updatePageWithContract(contractData)
                            var abiSource = document.getElementById('contract-abi').value
                            var abihtml = new AbiHtml(abiSource)
                            if (abihtml) {
                                loadedAbihtml[0] = abihtml
                                makeFunctionForm(abihtml)
                                updateEventList(abihtml)
                                abihtml.GetEventLogs(getEventOptions(), true, function(evmEvent) {
                                    makeEventNotification(evmEvent, displayNotification)
                                })
                            }
                        })
                    }
                })
            })
        } else {
            connectInstance()
            if (testConnection()) {
                updateDashboard()
                watchBlocks()
            }

        }
    }



    var setHandlers = function() {
        var handlers = [{
            name: 'clear-notifications',
            e: 'click',
            f: function() {
                clearNotifications()
                resetEventList()
            }
        }, {
            name: 'connect-instance',
            e: 'click',
            f: connectInstance
        }, {
            name: 'gas',
            e: 'keyup',
            f: updateMaxTxCost
        }, {
            name: 'gasprice-amount',
            e: '',
            f: updateMaxTxCost
        }, {
            name: 'event-list',
            e: 'change',
            f: function() {
                var eventName = document.getElementById('event-list').value
                var index = document.getElementById('event-list').selectedIndex
                var abihtml = loadedAbihtml[0]

                if (eventName in abihtml.events) {
                    var dom = makeEventTopicFilter(abihtml.events[eventName])
                    displayEventFilter(dom)
                } else if (eventName === "*") {
                    clearNotifications()
                    abihtml.GetAllEvents(getEventOptions(), {}, function(evmEvent) {
                        makeEventNotification(evmEvent, displayNotification)
                    })
                } else {
                    console.log('event-list none')
                    clearNotifications()
                }
            }
        }, {
            name: 'contract-address',
            e: 'keyup',
            f: updateToBalance
        }, {
            name: 'contract-address',
            e: 'change',
            f: updateToBalance
        }, {
            name: 'deploy-contract',
            e: 'click',
            f: function() {
                deployContract(function(error, result) {
                    if (error) {
                        displayNotification(displayNotification(error.toString()), 'error')
                            // var receipt = web3.eth.getTransactionReceipt(result.transactionHash, function(receipt) {
                    } else {
                        displayNotification('Deployed contract in transaction: <pre>' + result.transactionHash + '</pre>', 'warning')

                        if (!result.address) {
                            setTimeout(function() {
                                makeContractNotification(result)
                            }, 5000)
                        } else {
                            makeContractNotification(result)
                        }
                    }

                })
            }
        }, {
            name: 'generate-page',
            e: 'click',
            f: function() {
                var abiString = document.getElementById('contract-abi').value
                var abihtml = new AbiHtml(abiString)
                if (abihtml) {
                    loadedAbihtml[0] = abihtml
                    makeFunctionForm(abihtml)
                    updateEventList(abihtml)
                }
            }
        }, {
            name: 'compile-contract',
            e: 'click',
            f: function() {
                var source = document.getElementById('contract-code').value
                var abihtml = updatePageWithSource(source)
                if (abihtml) loadedAbihtml[0] = abihtml
            }

        }, {
            name: 'gasprice-copy',
            e: 'click',
            f: function() {
                updateGasprice()
                updateMaxTxCost()
            }
        }, {
            name: 'send-value',
            e: 'click',
            f: function() {
                txhash = web3.eth.sendTransaction(getTransactionOptions())

                // // this doesn't work because it doens't wait for it to be mined
                // // it needs a timer like contract creation
                // web3.eth.getTransactionReceipt(txhash, function(err, txReceipt) {
                //     console.log(err, txReceipt)
                // })

                displayNotification('Sent transaction: <pre>' + txhash + '</pre>', 'warning')
            }
        }, {
            name: 'copy-from',
            e: 'click',
            f: function() {
                document.getElementById('contract-address').value = document.getElementById('sender-address').value
                updateToBalance()
            }
        }, {
            name: 'value-unit',
            e: 'change',
            f: function() {
                if (testConnection()) {
                    updateBalances()
                    updateMaxTxCost()
                    updateToBalance()
                }
            }
        }, {
            name: 'gasprice-unit',
            e: 'change',
            f: function() {
                if (testConnection()) {
                    // below will override the number part, which is ugly
                    // this also requires us to update the maximum cost
                    // better would be to keep the value and convert it
                    // via option value
                    updateGasprice()
                    updateMaxTxCost()
                }
            }
        }, {
            name: 'contract-selector',
            e: 'change',
            f: function() {
                var select = document.getElementById('contract-selector')
                var userContract = JSON.parse(select.options[select.selectedIndex].value)
                var abiSource = JSON.stringify(userContract.info.abiDefinition)
                document.getElementById('contract-abi').value = abiSource
                var abihtml = updatePageWithAbi(abiSource)
                if (abihtml) loadedAbihtml[0] = abihtml
            }
        }]

        for (k in handlers) {
            var obj = handlers[k]
            if (obj.name && obj.e && obj.f)
                document.getElementById(obj.name).addEventListener(obj.e, obj.f, false)
        }


    }
    </script>
</head>

<body>
    <div id="header">
        <div id="header-wrapper">
            <div id="node">
                <button type="button" id="connect-instance">Connect</button>
                <samp>geth --rpc --rpcaddr "</samp>
                <input type="text" id="instance-hostname" value="127.0.0.1">
                <samp>" --rpcport "
                    <input type="text" id="instance-port" value="8545">" --rpccorsdomain "*" --unlock "&lt;ACCOUNT1&gt; &lt;ACCOUNT2&gt; &lt;ACCOUNT3&gt;"
                </samp>
                <p>
                    Block height: <span id="block-height">?</span> Best hash: <span id="block-hash">?</span> Estimated gas price: <span id="network-gasprice">?</span>
                </p>
            </div>
            <div id="dashboard">
                <div id="contract">
                    <label for="contract-code">Contract</label>
                    <button type="button" id="compile-contract" disabled>Compile</button>
                    <label for="contract-selector">Deploy contract:</label>
                    <select id="contract-selector" disabled></select>
                    <button type="button" id="deploy-contract" disabled>Deploy</button>
                    <br>
                    <textarea id="contract-code"></textarea>
                </div>
                <div id="abi">
                    <label for="contract-abi">Contract ABI</label>
                    <button type="button" id="generate-page">Generate Form</button>
                    <br>
                    <textarea id="contract-abi"></textarea>
                </div>
            </div>
            <div id="controls">
                <div>
                    <label for="sender-address">From:</label>
                    <select id="sender-address" class="in-address"></select>
                    <button type="button" id="copy-from" disabled>Copy To</button>
                </div>
                <div>
                    <label for="contract-address">To:</label>
                    <input id="contract-address" type="text" class="in-address">
                    <label for="contract-balance">Balance:</label>
                    <span id="contract-balance"></span>
                </div>
                <div>
                    <label for="value-amount">Value</label>
                    <input id="value-amount" type="text">
                    <select id="value-unit">
                        <option selected="">ether</option>
                        <option>finney</option>
                        <option>szabo</option>
                        <option>shannon</option>
                        <option>babbage</option>
                        <option>ada</option>
                        <option>wei</option>
                    </select>
                </div>
                <div>
                    <label for="gas">Gas:</label>
                    <input id="gas" type="text" class="" value="3000000">
                </div>
                <div>
                    <label for="gas-price">Gas price:</label>
                    <input id="gasprice-amount" type="text" class="" value="10">
                    <select id="gasprice-unit">
                        <option>ether</option>
                        <option>finney</option>
                        <option selected>szabo</option>
                        <option>shannon</option>
                        <option>babbage</option>
                        <option>ada</option>
                        <option>wei</option>
                    </select>
                    <button id="gasprice-copy" disabled>Sync estimate</button>
                </div>
                <div>
                    <span>Max cost: <span id="txcost-total">?</span></span>
                    <button id="send-value" type="button" disabled>Send</button>
                </div>
            </div>
        </div>
    </div>
    <div id="main">
        <div id="functions">
            <h2>Actions</h2>
            <div id="tab-container">
                <ul>
                </ul>
            </div>
            <div id="main-container">
            </div>
        </div>
        <div id="events">
            <h2>Notifications</h2>
            <select id="event-list"></select>
            <button type="button" id="clear-notifications">Clear all</button>
            <div id="notifications"></div>
        </div>
    </div>
    <div id="footer">
    </div>
</body>

</html>
