<!doctype>
<html>

<head>
    <title>abi2html</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="index2.css">
    <script type="text/javascript" src="./dist/bignumber.min.js"></script>
    <script type="text/javascript" src="./dist/web3-light.min.js"></script>
    <script type="text/javascript" src="./lib/abi2html.js"></script>
    <script type="text/javascript">
    var loadedAbiHtml = []
    var selectedDocIndex
    var web3 = new Web3()

    window.onload = function() {
        var gistId = getParameterByName('GIST_ID')
        var toAddress = getParameterByName('ADDRESS')

        // set defaults for friendliness
        if (!gistId) {
            if (window.location.protocol === "file:") {
                // debug
                // gistId = "505534d5a37ffa3a0625"
                gistId = "0e1b884de82d35053a34"
                toAddress = "0x63f33b08404987648ce2dde79715e14e8b69e4d8"
            } else if (window.location.host === 'tgerring.github.io') {
                // public
                gistId = "0e1b884de82d35053a34"
                toAddress = "0xde0b295669a9fd93d5f28d9ec85e40f4cb697bae"
            }
        }

        // preload resources
        if (gistId) {
            callAjax('https://api.github.com/gists/' + gistId, function(response) {
                if (response === null) return

                var result = JSON.parse(response)
                if (result) {
                    var i = 0
                    for (var filename in result.files) {
                        var ah = new AbiHtml(result.files[filename].content)
                        ah.name = filename
                        loadedAbiHtml[i] = ah
                        i++
                    }
                }

                // render code
                selectedDocIndex = 0
                displayCode(selectedDocIndex)
                displayUi(selectedDocIndex)
            })
        } else {
            document.getElementById('main').classList.add('flip')
        }

        setHandlers()
    }

    var setHandlers = function() {
        document.getElementById('btnSave').addEventListener('click', function(ev) {
            updateDoc(selectedDocIndex)
            displayCode(selectedDocIndex)
            displayUi(selectedDocIndex)
        }, false)
        document.getElementById('btnViewInterface').addEventListener('click', function(ev) {
            // updateDoc(selectedDocIndex) // this can be slow
            displayUi(selectedDocIndex)
            document.getElementById('main').classList.toggle('flip')
        }, false)
        document.getElementById('btnDeploy').addEventListener('click', function(ev) {
            displayModal('Deployment parameters should go here')
        }, false)
        document.getElementById('btnWatch').addEventListener('click', function(ev) {
            loadedAbiHtml[selectedDocIndex]

            if (connectInstance()) {
                var filter = web3.eth.filter('latest')
                var block = web3.eth.getBlock('latest')
                var el = document.getElementById('notification-anchor')
                el.children[0].innerHTML = 'Block #' + block.number
                el.children[0].classList.add('success')
                filter.watch(function(err, result) {
                    var block = web3.eth.getBlock(result)
                    var el = document.getElementById('notification-anchor')
                    el.children[0].innerHTML = 'Block #' + block.number
                })
            } else {
                displayNotification('Could not connect to node', 'error')
            }

        }, false)
    }

    var getParameterByName = function(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]")
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
            results = regex.exec(location.search)
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "))
    }

    var callAjax = function(url, callback) {
        var xmlhttp
        xmlhttp = new XMLHttpRequest()
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                callback(xmlhttp.responseText)
            }
        }
        xmlhttp.onerror = function() {
            callback(null)
        }
        xmlhttp.open("GET", url, true)
        xmlhttp.send()
    }

    var connectInstance = function() {
        if (!web3.currentProvider)
            web3.setProvider(new web3.providers.HttpProvider('http://127.0.0.1:8545'))

        return web3.isConnected()
    }


    var displayModal = function(obj) {
        var htmlDom
        if (typeof obj === "object" && "nodeType" in obj) {
            // looks like HTML Element
            htmlDom = obj
        } else if (typeof obj === "string") {
            // looks like string
            var htmlDom = document.createElement('p')
            htmlDom.innerHTML = obj
        }

        var parElement = document.createElement('div')
        parElement.classList.add('modal')
        var button = document.createElement('input')
        button.type = 'button'
        button.value = 'Close'
        button.addEventListener('click', function() {
            document.getElementsByTagName("body")[0].classList.remove('dialogIsOpen')
        }, false)
        parElement.appendChild(button)
        parElement.appendChild(htmlDom)

        // append the entry and the top
        var el = document.getElementById('modal')
        el.innerHTML = ''
        el.appendChild(parElement)

        document.getElementsByTagName("body")[0].classList.add('dialogIsOpen')
    }

    var displayNotification = function(obj, className) {
        var htmlDom
        if (typeof obj === "object" && "nodeType" in obj) {
            // looks like HTML Element
            htmlDom = obj
        } else if (typeof obj === "string") {
            // looks like string
            var htmlDom = document.createElement('p')
            htmlDom.innerHTML = obj
        }

        var parElement = document.createElement('div')
        parElement.className = 'notification'
        if (className) parElement.classList.add(className)
        parElement.appendChild(htmlDom)

        // append the entry and the top
        var el = document.getElementById('notifications')
        el.appendChild(parElement)

    }


    var displayCode = function(index) {
        if (!(index in loadedAbiHtml)) return

        // draw all docs
        var ul = document.createElement('ul')
        for (var i = 0; i < loadedAbiHtml.length; i++) {
            var ah = loadedAbiHtml[i]
            var li = document.createElement('li')
            var a = document.createElement('a')
            a.loadDoc = i
            a.addEventListener('click', function(ev) {
                selectedDocIndex = ev.srcElement.loadDoc
                displayCode(selectedDocIndex)
            }, false)
            if ('name' in ah) a.innerHTML = ah.name
            else a.innerHTML = 'Untitled' + i.toString()
            if (selectedDocIndex === i) li.classList.add('selected')
            li.appendChild(a)
            ul.appendChild(li)
        }

        // add a trailing tab for adding new documents
        var addTab = document.createElement('li')
        var a = document.createElement('a')
        a.innerHTML = "+"
        a.addEventListener('click', function(ev) {
            var ah = new AbiHtml()
            selectedDocIndex = loadedAbiHtml.length
            loadedAbiHtml.push(ah)
            displayCode(selectedDocIndex)
        }, false)
        addTab.appendChild(a)
        ul.appendChild(addTab)

        // display loaded doc
        var target = document.getElementById('docnav')
        target.innerHTML = ''
        target.appendChild(ul)

        var ah = loadedAbiHtml[index]
        document.getElementById('abi-code').value = (ah.abi ? JSON.stringify(ah.abi, null, "  ") : '')
        document.getElementById('source-code').value = (ah.source ? ah.source : '')
    }

    var displayUi = function(index) {
        var ah = loadedAbiHtml[index]

        document.getElementById('main-container').innerHTML = ''
        ah.GetFunctionsSorted().forEach(function(f) {
            var section = document.createElement('section')
            section.classList.add('ac-container')
            var div = document.createElement('div')
            var input = document.createElement('input')
            input.type = 'checkbox'
            input.id = 'acc-' + f.name
            input.name = 'acc-functions'
            var label = document.createElement('label')
            label.htmlFor = input.id
            label.innerHTML = f.name
            var article = document.createElement('article')
            article.appendChild(f.makeFieldForm())
            article.classList.add('ac-large')
            div.appendChild(input)
            div.appendChild(label)
            div.appendChild(article)
            section.appendChild(div)

            document.getElementById('main-container').appendChild(section)
        })

        document.getElementById('log-search').innerHTML = ''
        ah.GetEventsSorted().forEach(function(e) {
            var section = document.createElement('section')
            section.classList.add('ac-container')
            var div = document.createElement('div')
            var input = document.createElement('input')
            input.type = 'checkbox'
            input.id = 'acc-' + e.name
            input.name = 'acc-events'
            var label = document.createElement('label')
            label.htmlFor = input.id
            label.innerHTML = e.name
            var article = document.createElement('article')
            article.appendChild(e.makeFieldFilter())
            article.classList.add('ac-medium')
            div.appendChild(input)
            div.appendChild(label)
            div.appendChild(article)
            section.appendChild(div)

            document.getElementById('log-search').appendChild(section)
        })
    }

    var updateDoc = function(index) {
        var source = document.getElementById('source-code').value
        var abi = document.getElementById('abi-code').value

        var ah
        if (source) ah = new AbiHtml(source)
        else if (abi) ah = new AbiHtml(abi)
        if (name in ah) ah.name = loadedAbiHtml[index].name

        if (ah) loadedAbiHtml[index] = ah
    }
    </script>
</head>

<body>
    <div id="modalwrapper">
        <div id="modal">
        </div>
    </div>
    <div class="page-wrap">
        <div id="main" class="flip-container full-size">
            <div class="flipper">
                <div id="uiview" class="front">
                    <div class="header">
                        <div class="wrapper nowrap">
                            <div>
                                <div id="notifications" class="notifications nowrap">
                                    <div>Block #1000
                                        <hr>ConfirmationNeeded
                                    </div>
                                    <div>Block #1001
                                        <hr>Confirmation</div>
                                    <div>Block #1050
                                        <hr>Confirmation</div>
                                    <div>Block #1100
                                        <hr>Confirmation
                                        <br>MultiTransact
                                    </div>
                                </div>
                            </div>
                            <div id="notification-anchor">
                                <div class="notification">Not connected</div>
                                <div class="inline">
                                    <input class="stack" type="button" onclick="document.getElementById('main').classList.toggle('flip');" value="Code">
                                    <input type="button" id="btnWatch" value="Watch">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="main">
                        <div class="wrapper">
                            <div id="functions">
                                <div>
                                    <h2>Functions</h2>
                                    <div>
                                        <div id="tab-container">
                                            <ul>
                                            </ul>
                                        </div>
                                        <div id="main-container">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="logs">
                                <div>
                                    <h2>Events</h2>
                                    <div id="log-search"></div>
                                    <div id="message-container"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="codeview" class="back">
                    <div class="header">
                        <div class="wrapper">
                            <nav id="docnav">
                            </nav>
                            <div>
                                <input type="button" id="btnDeploy" value="Deploy">
                                <input type="button" id="btnSave" value="Save">
                                <input type="button" id="btnViewInterface" value="UI">
                            </div>
                        </div>
                    </div>
                    <div class="main">
                        <div class="wrapper">
                            <div id="contract">
                                <div>
                                    <textarea placeholder="contract" id="source-code"></textarea>
                                </div>
                            </div>
                            <div id="abi">
                                <div>
                                    <textarea placeholder="abi" id="abi-code"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
